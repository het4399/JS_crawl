<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üï∑Ô∏è Fast Web Crawler</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      
      body { 
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }
      
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }
      
      .header {
        text-align: center;
        margin-bottom: 30px;
        color: white;
      }
      
      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      }
      
      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }
      
      .main-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 30px;
      }
      
      .controls {
        display: grid;
        grid-template-columns: 1fr auto auto auto auto;
        gap: 15px;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }
      
      .url-input {
        padding: 12px 16px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: #f8f9fa;
      }
      
      .url-input:focus {
        outline: none;
        border-color: #667eea;
        background: white;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .control-group {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
      }
      
      .control-group label {
        font-weight: 500;
        color: #555;
        font-size: 14px;
      }
      
      .checkbox {
        width: 18px;
        height: 18px;
        accent-color: #667eea;
      }
      
      .number-input {
        width: 80px;
        padding: 8px 12px;
        border: 2px solid #e1e5e9;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
      }
      
      .select {
        padding: 8px 12px;
        border: 2px solid #e1e5e9;
        border-radius: 6px;
        font-size: 14px;
        background: white;
        cursor: pointer;
      }
      
      .start-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }
      
      .start-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }
      
      .start-btn:active {
        transform: translateY(0);
      }
      
      .start-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .status-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #28a745;
        animation: pulse 2s infinite;
      }
      
      .status-dot.crawling {
        background: #ffc107;
      }
      
      .status-dot.error {
        background: #dc3545;
        animation: none;
      }
      
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
      }
      
      .count {
        font-size: 1.2rem;
        font-weight: 700;
        color: #667eea;
      }
      
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }
      
      .panel {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        border: 1px solid #e9ecef;
      }
      
      .panel h3 {
        margin-bottom: 15px;
        color: #495057;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .panel-icon {
        font-size: 1.2rem;
      }
      
      #logs, #pages {
        height: 300px;
        overflow-y: auto;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        line-height: 1.4;
      }
      
      #logs {
        color: #6c757d;
      }
      
      #pages {
        color: #495057;
      }
      
      .log-entry {
        margin-bottom: 8px;
        padding: 4px 0;
        border-bottom: 1px solid #f1f3f4;
      }
      
      .log-entry:last-child {
        border-bottom: none;
      }
      
      .page-entry {
        margin-bottom: 8px;
        padding: 6px 0;
      }
      
      .page-entry a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
      }
      
      .page-entry a:hover {
        color: #5a6fd8;
        text-decoration: underline;
      }
      
      .empty-state {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 40px 20px;
      }
      
      .monitoring-link {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
        text-decoration: none;
        padding: 10px 16px;
        border-radius: 25px;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }
      
      .monitoring-link:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      }
      
      .export-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e9ecef;
      }
      
      .export-section h3 {
        margin-bottom: 15px;
        color: #495057;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      
      .export-controls {
        display: flex;
        gap: 12px;
        align-items: center;
        flex-wrap: wrap;
      }
      
      .export-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
      }
      
      .export-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }
      
      .export-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      
      .export-btn:active:not(:disabled) {
        transform: translateY(0);
      }
      
      @media (max-width: 768px) {
        .controls {
          grid-template-columns: 1fr;
          gap: 10px;
        }
        
        .grid {
          grid-template-columns: 1fr;
        }
        
        .header h1 {
          font-size: 2rem;
        }
        
        .container {
          padding: 15px;
        }
        
        .main-card {
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <a href="/monitoring.html" class="monitoring-link">üìä Monitoring Dashboard</a>
    
    <div class="container">
      <div class="header">
        <h1>üï∑Ô∏è Fast Web Crawler</h1>
        <p>Discover and crawl websites with powerful monitoring and analytics</p>
      </div>

      <div class="main-card">
        <div class="controls">
          <input id="url" class="url-input" placeholder="https://example.com" />
          
          <div class="control-group">
            <input id="subs" type="checkbox" class="checkbox" />
            <label for="subs">Subdomains</label>
          </div>
          
          <div class="control-group">
            <label for="conc">Concurrency</label>
            <input id="conc" type="number" min="1" max="500" value="150" class="number-input" />
          </div>
          
          <div class="control-group">
            <select id="mode" class="select">
        <option value="html" selected>HTML only (fast)</option>
        <option value="auto">Auto (fallback to JS)</option>
        <option value="js">JS only (Playwright)</option>
      </select>
          </div>
          
          <button id="start" class="start-btn">üöÄ Start Crawl</button>
        </div>

        <div class="export-section">
          <h3><span class="panel-icon">üì§</span> Export Results</h3>
          <div class="export-controls">
            <select id="exportFormat" class="select">
              <option value="json">JSON</option>
              <option value="csv">CSV</option>
              <option value="txt">Text (URLs only)</option>
              <option value="xml">XML</option>
            </select>
            <button id="exportBtn" class="export-btn" disabled>üì• Export Data</button>
            <button id="exportMetricsBtn" class="export-btn" disabled>üìä Export Metrics</button>
          </div>
        </div>

        <div class="status-bar">
          <div class="status-indicator">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">Ready to crawl</span>
          </div>
          <div class="count" id="count">0 pages discovered</div>
        </div>

        <div class="grid">
          <div class="panel">
            <h3><span class="panel-icon">üìù</span> Live Logs</h3>
            <div id="logs">
              <div class="empty-state">Waiting for crawl to start...</div>
            </div>
    </div>

          <div class="panel">
            <h3><span class="panel-icon">üîó</span> Discovered Pages</h3>
            <div id="pages">
              <div class="empty-state">No pages discovered yet</div>
            </div>
          </div>
      </div>
      </div>
    </div>

    <script>
      const logs = document.getElementById('logs');
      const pages = document.getElementById('pages');
      const countEl = document.getElementById('count');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const startBtn = document.getElementById('start');
      const exportBtn = document.getElementById('exportBtn');
      const exportMetricsBtn = document.getElementById('exportMetricsBtn');
      const exportFormat = document.getElementById('exportFormat');
      let pageCount = 0;
      let isCrawling = false;
      let hasData = false;

      function updateStatus(status, text) {
        statusDot.className = `status-dot ${status}`;
        statusText.textContent = text;
      }

      function addLog(msg) {
        // Clear empty state if present
        const emptyState = logs.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span style="color: #6c757d;">[${new Date().toLocaleTimeString()}]</span> ${msg}`;
        logs.appendChild(div);
        logs.scrollTop = logs.scrollHeight;
      }

      function addPage(url) {
        // Clear empty state if present
        const emptyState = pages.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        const div = document.createElement('div');
        div.className = 'page-entry';
        
        const a = document.createElement('a');
        a.href = url;
        a.target = '_blank';
        a.rel = 'noreferrer noopener';
        a.textContent = url;
        
        div.appendChild(a);
        pages.appendChild(div);
        pages.scrollTop = pages.scrollHeight;
        
        pageCount += 1;
        countEl.textContent = `${pageCount} pages discovered`;
      }

      function resetUI() {
        pageCount = 0;
        countEl.textContent = '0 pages discovered';
        logs.innerHTML = '<div class="empty-state">Waiting for crawl to start...</div>';
        pages.innerHTML = '<div class="empty-state">No pages discovered yet</div>';
        updateStatus('', 'Ready to crawl');
        isCrawling = false;
        hasData = false;
        startBtn.disabled = false;
        startBtn.textContent = 'üöÄ Start Crawl';
        exportBtn.disabled = true;
        exportMetricsBtn.disabled = true;
      }

      function updateExportButtons() {
        exportBtn.disabled = !hasData || isCrawling;
        exportMetricsBtn.disabled = !hasData || isCrawling;
      }

      async function exportData() {
        if (!hasData) return;
        
        try {
          const format = exportFormat.value;
          const url = `/api/export?format=${format}`;
          
          addLog(`üì§ Exporting data as ${format.toUpperCase()}...`);
          
          const response = await fetch(url);
          if (!response.ok) throw new Error('Export failed');
          
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = `crawl-results-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.${format}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(downloadUrl);
          
          addLog(`‚úÖ Data exported successfully as ${format.toUpperCase()}`);
        } catch (error) {
          addLog(`‚ùå Export failed: ${error.message}`);
        }
      }

      async function exportMetrics() {
        if (!hasData) return;
        
        try {
          const format = exportFormat.value;
          const url = `/api/export/metrics?format=${format}`;
          
          addLog(`üìä Exporting metrics as ${format.toUpperCase()}...`);
          
          const response = await fetch(url);
          if (!response.ok) throw new Error('Metrics export failed');
          
          const blob = await response.blob();
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = downloadUrl;
          a.download = `crawl-metrics-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.${format}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(downloadUrl);
          
          addLog(`‚úÖ Metrics exported successfully as ${format.toUpperCase()}`);
        } catch (error) {
          addLog(`‚ùå Metrics export failed: ${error.message}`);
        }
      }

      const evt = new EventSource('/events');
      evt.addEventListener('log', (e) => {
        const data = JSON.parse(e.data);
        addLog(data.message);
      });
      evt.addEventListener('page', (e) => {
        const data = JSON.parse(e.data);
        addPage(data.url);
        hasData = true;
        updateExportButtons();
      });
      evt.addEventListener('done', (e) => {
        const data = JSON.parse(e.data);
        addLog(`‚úÖ Crawl completed! Total pages: ${data.count}`);
        updateStatus('', 'Crawl completed');
        isCrawling = false;
        hasData = true;
        startBtn.disabled = false;
        startBtn.textContent = 'üöÄ Start Crawl';
        updateExportButtons();
      });

      startBtn.addEventListener('click', async () => {
        if (isCrawling) return;
        
        resetUI();
        const url = document.getElementById('url').value.trim();
        const allowSubdomains = document.getElementById('subs').checked;
        const maxConcurrency = Number(document.getElementById('conc').value) || 150;
        const mode = document.getElementById('mode').value;
        
        if (!url) { 
          addLog('‚ùå Please enter a URL to crawl');
          updateStatus('error', 'Error: URL required');
          return; 
        }
        
        try {
          isCrawling = true;
          startBtn.disabled = true;
          startBtn.textContent = '‚è≥ Crawling...';
          updateStatus('crawling', 'Crawling in progress...');
          
          const res = await fetch('/crawl', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, allowSubdomains, maxConcurrency, mode })
          });
          
          if (!res.ok) throw new Error(await res.text());
          
          addLog(`üöÄ Starting crawl of ${url}`);
          addLog(`üìä Mode: ${mode}, Concurrency: ${maxConcurrency}, Subdomains: ${allowSubdomains ? 'Yes' : 'No'}`);
        } catch (e) {
          addLog(`‚ùå Error: ${e.message}`);
          updateStatus('error', 'Crawl failed');
          isCrawling = false;
          startBtn.disabled = false;
          startBtn.textContent = 'üöÄ Start Crawl';
        }
      });

      // Add event listeners for export buttons
      exportBtn.addEventListener('click', exportData);
      exportMetricsBtn.addEventListener('click', exportMetrics);

      // Add Enter key support for URL input
      document.getElementById('url').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !isCrawling) {
          startBtn.click();
        }
      });

      // Initialize export buttons
      updateExportButtons();
    </script>
  </body>
  </html>


