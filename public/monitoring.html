<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crawler Monitoring Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: #f5f5f5; 
            color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px;
        }
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card h3 { margin-bottom: 15px; color: #2c3e50; }
        .status { 
            display: inline-block; 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 12px; 
            font-weight: bold;
            text-transform: uppercase;
        }
        .status.healthy { background: #d4edda; color: #155724; }
        .status.degraded { background: #fff3cd; color: #856404; }
        .status.unhealthy { background: #f8d7da; color: #721c24; }
        .metric { 
            display: flex; 
            justify-content: space-between; 
            margin: 10px 0; 
            padding: 8px 0; 
            border-bottom: 1px solid #eee;
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { font-weight: 500; }
        .metric-value { font-weight: bold; color: #2c3e50; }
        .chart { height: 200px; background: #f8f9fa; border-radius: 4px; margin: 10px 0; }
        .log-entry { 
            padding: 8px; 
            margin: 4px 0; 
            background: #f8f9fa; 
            border-radius: 4px; 
            font-family: monospace; 
            font-size: 12px;
        }
        .log-entry.error { background: #f8d7da; color: #721c24; }
        .log-entry.warn { background: #fff3cd; color: #856404; }
        .log-entry.info { background: #d1ecf1; color: #0c5460; }
        .log-entry.debug { background: #e2e3e5; color: #383d41; }
        .refresh-btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 10px 5px;
        }
        .refresh-btn:hover { background: #0056b3; }
        .auto-refresh { margin: 10px 0; }
        .auto-refresh input { margin-right: 8px; }
        .error-summary { margin: 10px 0; }
        .error-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 5px 0; 
            border-bottom: 1px solid #eee;
        }
        .progress-bar { 
            width: 100%; 
            height: 20px; 
            background: #e9ecef; 
            border-radius: 10px; 
            overflow: hidden; 
            margin: 5px 0;
        }
        .progress-fill { 
            height: 100%; 
            background: #28a745; 
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üï∑Ô∏è Crawler Monitoring Dashboard</h1>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" checked>
                <label for="autoRefresh">Auto-refresh (5s)</label>
                <button class="refresh-btn" onclick="refreshAll()">Refresh Now</button>
                <button class="refresh-btn" onclick="clearLogs()">Clear Logs</button>
                <button class="refresh-btn" onclick="exportData()">üì• Export Data</button>
                <button class="refresh-btn" onclick="exportMetrics()">üìä Export Metrics</button>
            </div>
        </div>

        <div class="grid">
            <!-- Health Status -->
            <div class="card">
                <h3>üè• Health Status</h3>
                <div id="healthStatus">Loading...</div>
                <div id="healthDetails"></div>
            </div>

            <!-- Crawl Metrics -->
            <div class="card">
                <h3>üìä Crawl Metrics</h3>
                <div id="crawlMetrics">Loading...</div>
            </div>

            <!-- Performance -->
            <div class="card">
                <h3>‚ö° Performance</h3>
                <div id="performance">Loading...</div>
            </div>

            <!-- Error Summary -->
            <div class="card">
                <h3>‚ùå Error Summary</h3>
                <div id="errorSummary">Loading...</div>
            </div>
        </div>

        <div class="grid">
            <!-- Recent Logs -->
            <div class="card">
                <h3>üìù Recent Logs</h3>
                <div id="recentLogs">Loading...</div>
            </div>

            <!-- Request History -->
            <div class="card">
                <h3>üîç Recent Requests</h3>
                <div id="requestHistory">Loading...</div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval;
        const autoRefreshCheckbox = document.getElementById('autoRefresh');

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDuration(ms) {
            if (ms < 1000) return ms + 'ms';
            if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
            return (ms / 60000).toFixed(1) + 'm';
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        async function fetchHealth() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const statusEl = document.getElementById('healthStatus');
                const detailsEl = document.getElementById('healthDetails');
                
                statusEl.innerHTML = `<span class="status ${data.status}">${data.status}</span>`;
                
                detailsEl.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Uptime</span>
                        <span class="metric-value">${formatDuration(data.uptime)}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Memory Usage</span>
                        <span class="metric-value">${data.memory.percentage}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active Crawls</span>
                        <span class="metric-value">${data.activeCrawls}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Queue Size</span>
                        <span class="metric-value">${data.queueSize}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Error Count</span>
                        <span class="metric-value">${data.errors.count}</span>
                    </div>
                `;
            } catch (error) {
                document.getElementById('healthStatus').innerHTML = '<span class="status unhealthy">Error</span>';
            }
        }

        async function fetchMetrics() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                
                document.getElementById('crawlMetrics').innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Total Pages</span>
                        <span class="metric-value">${data.totalPages}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Successful Requests</span>
                        <span class="metric-value">${data.successfulRequests}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Failed Requests</span>
                        <span class="metric-value">${data.failedRequests}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Success Rate</span>
                        <span class="metric-value">${data.totalPages > 0 ? Math.round((data.successfulRequests / data.totalPages) * 100) : 0}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Duration</span>
                        <span class="metric-value">${formatDuration(data.duration)}</span>
                    </div>
                `;
            } catch (error) {
                document.getElementById('crawlMetrics').innerHTML = 'Error loading metrics';
            }
        }

        async function fetchPerformance() {
            try {
                const response = await fetch('/api/metrics');
                const data = await response.json();
                
                document.getElementById('performance').innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Avg Response Time</span>
                        <span class="metric-value">${data.averageResponseTime}ms</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Requests/Min</span>
                        <span class="metric-value">${data.requestsPerMinute}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Pages/Second</span>
                        <span class="metric-value">${data.duration > 0 ? Math.round(data.totalPages / (data.duration / 1000)) : 0}</span>
                    </div>
                `;
            } catch (error) {
                document.getElementById('performance').innerHTML = 'Error loading performance data';
            }
        }

        async function fetchErrorSummary() {
            try {
                const response = await fetch('/api/errors');
                const data = await response.json();
                
                let html = '';
                if (data.length === 0) {
                    html = '<div style="color: #28a745; font-weight: bold;">No errors! üéâ</div>';
                } else {
                    data.forEach(error => {
                        html += `
                            <div class="error-item">
                                <span>${error.type}</span>
                                <span>${error.count} (${error.percentage}%)</span>
                            </div>
                        `;
                    });
                }
                
                document.getElementById('errorSummary').innerHTML = html;
            } catch (error) {
                document.getElementById('errorSummary').innerHTML = 'Error loading error summary';
            }
        }

        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs?limit=20');
                const data = await response.json();
                
                let html = '';
                data.reverse().forEach(log => {
                    html += `
                        <div class="log-entry ${log.level.toLowerCase()}">
                            <strong>[${formatTimestamp(log.timestamp)}] ${log.level}:</strong> ${log.message}
                            ${log.url ? `<br><small>URL: ${log.url}</small>` : ''}
                            ${log.duration ? `<br><small>Duration: ${log.duration}ms</small>` : ''}
                        </div>
                    `;
                });
                
                document.getElementById('recentLogs').innerHTML = html || 'No logs available';
            } catch (error) {
                document.getElementById('recentLogs').innerHTML = 'Error loading logs';
            }
        }

        async function fetchRequestHistory() {
            try {
                const response = await fetch('/api/requests?limit=10');
                const data = await response.json();
                
                let html = '';
                data.reverse().forEach(req => {
                    const statusClass = req.success ? 'info' : 'error';
                    html += `
                        <div class="log-entry ${statusClass}">
                            <strong>[${formatTimestamp(req.timestamp)}]</strong> 
                            ${req.success ? '‚úÖ' : '‚ùå'} ${req.statusCode} - ${req.responseTime}ms
                            <br><small>${req.url}</small>
                            ${req.error ? `<br><small>Error: ${req.error}</small>` : ''}
                        </div>
                    `;
                });
                
                document.getElementById('requestHistory').innerHTML = html || 'No requests available';
            } catch (error) {
                document.getElementById('requestHistory').innerHTML = 'Error loading request history';
            }
        }

        async function refreshAll() {
            await Promise.all([
                fetchHealth(),
                fetchMetrics(),
                fetchPerformance(),
                fetchErrorSummary(),
                fetchLogs(),
                fetchRequestHistory()
            ]);
        }

        async function clearLogs() {
            try {
                await fetch('/api/logs', { method: 'DELETE' });
                await fetchLogs();
            } catch (error) {
                console.error('Failed to clear logs:', error);
            }
        }

        async function exportData() {
            try {
                const format = 'json'; // Default format for monitoring dashboard
                const url = `/api/export?format=${format}`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    if (response.status === 404) {
                        alert('No crawl data found to export');
                        return;
                    }
                    throw new Error('Export failed');
                }
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `crawl-results-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                console.log('Data exported successfully');
            } catch (error) {
                console.error('Export failed:', error);
                alert('Export failed: ' + error.message);
            }
        }

        async function exportMetrics() {
            try {
                const format = 'json'; // Default format for monitoring dashboard
                const url = `/api/export/metrics?format=${format}`;
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('Metrics export failed');
                
                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `crawl-metrics-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.${format}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);
                
                console.log('Metrics exported successfully');
            } catch (error) {
                console.error('Metrics export failed:', error);
                alert('Metrics export failed: ' + error.message);
            }
        }

        // Auto-refresh functionality
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            if (autoRefreshCheckbox.checked) {
                autoRefreshInterval = setInterval(refreshAll, 5000);
            }
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        autoRefreshCheckbox.addEventListener('change', () => {
            if (autoRefreshCheckbox.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        // Initial load
        refreshAll();
        startAutoRefresh();
    </script>
</body>
</html>
